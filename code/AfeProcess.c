/********************************************************************************
Copyright (C), Sinowealth Electronic. Ltd.
Author: 	andyliu
Version: 	V0.0
Date: 		2014/05/30
History:
	V0.0		2014/05/30		 Preliminary
********************************************************************************/
#include "system.h"
#include "AfeMtp.h"
#include "Calibrate.h"

/*******************************************************************************
Function: VolProtect(void)
Description:  
Input:	 	
Output: 
Others:
*******************************************************************************/
void VolProtect(void)
{
	if(!bHV)
	{
		if(uiCellVmax > E2uiOVvol) //4.25
		{		
			if(++ucOVcnt >= OV_DELAY_CNT)//40*25 = 1000mS
			{
				bHV = 1;
				ucOVcnt = 0;
				ucOVRcnt = 0;
			}
		}
		else if(uiCellVmax < E2uiOVRvol) //< 4.15
		{
			if(ucOVcnt > 0)
			{
				ucOVcnt--;
			}
		}
	}
	else
	{
		if(uiCellVmax < E2uiOVRvol)//ª÷∏¥ < 4.15v
		{			
			if(++ucOVRcnt >= OVR_DELAY_CNT)
			{
				bHV = 0;
				ucOVcnt = 0;
				ucOVRcnt = 0;
			}
		}
		else if(uiCellVmax > E2uiOVvol) //> 4.25v
		{
			if(ucOVRcnt > 0)
			{
				ucOVRcnt--;
			}
		}
	}

	if(!bUV)
	{
		if(uiCellVmin < E2uiUVvol) //≈–∂œ”–√ª”–«∑—π¡À//< 2.7v
		{		
			if(++ucUVcnt >= UV_DELAY_CNT)
			{
				bUV = 1;
				ucUVcnt = 0;
				ucUVRcnt = 0;

	      bChkChgerFlg = 1;//«∑—πµƒª∞“™ºÏ≤‚≥‰µÁ∆˜
	      bChgerConectFlg = 0;
				ucChgerCnt = 0;
	      REG.AFESCONF1 |= 0x01;//ø™∆Ù≥‰µÁ∆˜ºÏ≤‚
	      TWIWriteAFE(AFE_SCONF1, &REG.AFESCONF1);	// πƒ‹≥‰µÁ∆˜ºÏ≤‚
			}
		}
		else if(uiCellVmin > E2uiUVRvol)//> 3v
		{
			if(ucUVcnt > 0)
			{
				ucUVcnt--;
			}
		}
	}
	else
	{
		if(uiCellVmin > E2uiUVRvol)//3000
		{			
			if(++ucUVRcnt >= UVR_DELAY_CNT)
			{
				bUV = 0;
				ucUVcnt = 0;
				ucUVRcnt = 0;
			}
		}
		else if(uiCellVmin < E2uiUVvol)//2700
		{
			if(ucUVRcnt > 0)
			{
				ucUVRcnt--;
			}
		}
	}
#if debug
		printf("\n VolProtect(void) : bUV=%x,bHV=%x,\n",((uiBatStatus&0x0002)>>1),(uiBatStatus&0x0001));   
#endif	
}


/*******************************************************************************
Function: TempeProtect(void)
Description:  
Input:	 	
Output: 
Others:
*******************************************************************************/
void TempeProtect(void)								//TempNum=0, Support one temperature 
{
	if(!bOTC)//≥‰µÁ∏ﬂŒ¬
	{
		if(uiTempeMax > E2uiTempOTC) //50
		{
			if(++ucOTCcnt >= TEMPE_DELAY_CNT) //120*25 3s
			{
				bOTC = 1;
				ucOTCcnt = 0;
				ucOTCRcnt = 0;
			}
		}
		else if(uiTempeMax < E2uiTempOTCR)//E2uiTempOTCR”¶∏√“™±»E2uiTempOTC…‘Œ¢µÕµ„£¨“ÚŒ™ªÿ∏¥Œ¬∂»“™µÕµ„ 45
		{
			if(ucOTCcnt > 0)
			{
				ucOTCcnt--;
			}
		}
	}
	else
	{
		if(uiTempeMax < E2uiTempOTCR) //45 
		{
			if(++ucOTCRcnt >= TEMPER_DELAY_CNT)
			{
				bOTC = 0;
				ucOTCcnt = 0;
				ucOTCRcnt = 0;
			}
		}
		else if(uiTempeMax > E2uiTempOTC)
		{
			if(ucOTCRcnt > 0)
			{
				ucOTCRcnt--;
			}
		}
	}

	if(!bUTC)
	{
		if(uiTempeMin < E2uiTempUTC) //0
		{
			if(++ucUTCcnt >= TEMPE_DELAY_CNT)
			{
				bUTC = 1;
				ucUTCcnt = 0;
				ucUTCRcnt = 0;
			}
		}
		else if(uiTempeMin > E2uiTempUTCR)//5
		{
			if(ucUTCcnt > 0)
			{
				ucUTCcnt--;
			}
		}
	}
	else
	{
		if(uiTempeMin > E2uiTempUTCR)//5
		{
			if(++ucUTCRcnt >= TEMPER_DELAY_CNT)
			{
				bUTC = 0;
				ucUTCcnt = 0;
				ucUTCRcnt = 0;
			}
		}
		else if(uiTempeMin < E2uiTempUTC)//0
		{
			if(ucUTCRcnt > 0)
			{
				ucUTCRcnt--;
			}
		}
	}

	if(!bOTD)
	{
		if(uiTempeMax > E2uiTempOTD)//70  73
		{
			if(++ucOTDcnt >= TEMPE_DELAY_CNT)
			{
#if 0
		printf("\n bOTD = 1£∫Õ‚≤øuiTempeMax=%d,uiTempeMin=%d \n",uiTempeMax,uiTempeMin);    
#endif  		
				bOTD = 1;
				ucOTDcnt = 0;
				ucOTDRcnt = 0;
			}
		}
		else if(uiTempeMax < E2uiTempOTDR)
		{
			if(ucOTDcnt > 0)
			{
				ucOTDcnt--;
			}
		}
	}
	else
	{
		if(uiTempeMax < E2uiTempOTDR) //3311
		{
			if(++ucOTDRcnt >= TEMPER_DELAY_CNT)
			{
#if 0
		printf("\n bOTD = 0£∫Õ‚≤øuiTempeMax=%d,uiTempeMin=%d \n",uiTempeMax,uiTempeMin);    
#endif  	
				bOTD = 0;
				ucOTDcnt = 0;
				ucOTDRcnt = 0;
			}
		}
		else if(uiTempeMax > E2uiTempOTD)//70
		{
			if(ucOTDRcnt > 0)
			{
				ucOTDRcnt--;
			}
		}
	}

	if(!bUTD)
	{
		if(uiTempeMin < E2uiTempUTD)//-10
		{
			if(++ucUTDcnt >= TEMPE_DELAY_CNT)
			{
				bUTD = 1;
				ucUTDcnt = 0;
				ucUTDRcnt = 0;
			}
		}
		else if(uiTempeMin > E2uiTempUTDR)//-5
		{
			if(ucUTDcnt > 0)
			{
				ucUTDcnt--;
			}
		}
	}
	else
	{
		if(uiTempeMin > E2uiTempUTDR)//-5
		{
			if(++ucUTDRcnt >= TEMPER_DELAY_CNT)
			{
				bUTD = 0;
				ucUTDcnt = 0;
				ucUTDRcnt = 0;
			}
		}
		else if(uiTempeMin < E2uiTempUTD)//-10
		{
			if(ucUTDRcnt > 0)
			{
				ucUTDRcnt--;
			}
		}
	}
#if debug
		printf("\n TempeProtect(void) :bUTD=%x,bUTC=%x,bOTD=%x,bOTC=%x \n",((uiBatStatus&0x0800)>>11),((uiBatStatus&0x0400)>>10),((uiBatStatus&0x0200)>>9),((uiBatStatus&0x0100)>>8));   
#endif	
}


/*******************************************************************************
Function: ChkMosStatus(void)
Description:  
Input:	 	
Output: 
Others:
*******************************************************************************/
void ChkMosStatus(void)
{
		U8 bChgerConectFlg_test = 0x00;
    bCHGMOS = 1;
    bDSGMOS = 1;
//µÁ–æ>4.4v
	if(bAFE_OV || bCTO)//∂œœﬂ±£ª§£¨∫Õ”≤º˛π˝≥Â												  
	{
		bCHGMOS = 0;
	}
	//∑≈µÁ◊¥Ã¨£∫
	//(1)µ•ÃÂ«∑—πºÏ≤‚(µÕ”⁄◊ÓµÕµÁ—π ¥•∑¢)         bUV
	//(2)µ•ÃÂº‰—π≤ÓºÏ≤‚£®µ•ÃÂº‰—π≤Ó>0.3V ¥•∑¢£©  OK
	//(3)»˝∂À±£œ’Àø «∑Ò»€∂œ£®»€∂œ£©              OK
	//(4)∑≈µÁµÁ¡˜ºÏ≤‚£®π˝¡˜£¨∂Ã¬∑£©              bAFE_SC
	//(5)∏ﬂŒ¬ºÏ≤‚£®≥¨Œ¬ ¥•∑¢£©                   bOTD
	//(6)µÕŒ¬ºÏ≤‚£®≥¨Œ¬ ¥•∑¢£©                   bUTD
  //    																			 ªπ £: bOCD ||(bFD&&bDSGEnd) || bLoadConectFlg || bCTO
	//uiPackConfig≥ı ºªØ:00101101 00110111
//∑≈µÁ◊¥Ã¨œ¬µƒ¥ÌŒÛ±Í÷æ                         //∑≈µÁΩÿ÷π«“∑≈µÁΩÿ÷ππÿ±’∑≈µÁmosfet   ≥ı º◊¥Ã¨bLoadConectFlg = 0£¨ µÁ≥ÿ◊¥Ã¨∏’bstatus =0∏’ø™ ºÀ˘“‘bCTO = 0
																																//bLoadConectFlg «1µƒª∞æÕª·±£ª§£¨bLoadConectFlg÷ª”–‘⁄ºÏ≤‚∑¢…˙∑≈µÁµƒ¥ÌŒÛ◊¥Ã¨∫Û£¨ºÏ≤‚∏∫‘ÿ“¿»ª∫Û∏∫‘ÿ¡¨Ω”£¨≤≈ª·÷√1
	if( bOTD || bUTD || bUV || bOCD || bOCD2 || bAFE_SC || (bFD&&bDSGEnd) || bLoadConectFlg || bCTO)
	{																																//∫Û∆⁄“ÚŒ™∂Ã¬∑¥•∑¢bLoadConectFlgµƒø…ƒ‹ª·»•≥˝’‚“ªœÓ£¨≤ª”√ºÏ≤‚∏∫‘ÿ£¨”…≤Â»Î  ≈‰∆˜ªΩ–—
		bDSGMOS = 0;   //∑≈µÁmosπÿ±’
//		PWM2CON &= ~0x01; //pwmΩ˚÷π ‰≥ˆ	
//		DSG1PWM = 0;
	}
	else
	{
		//tomi
		//ÃÌº”∑≈µÁ’˝≥£µƒ≤Ÿ◊˜
		
//		DSG1PWM = 1;
//		if(ucDsgingSpeed != 2)
//		{
//			PWM2CON |= 0x01;
//		}
	}
   //packstatus≥ı º◊¥Ã¨∂º «0
    if(!bDSGING)//≤ª «∑≈µÁ◊¥Ã¨
    {
			  //(1)µ•ÃÂπ˝—πºÏ≤‚ (¥Û”⁄4.2V¥•∑¢±£ª§)                  bHV
				//(2)µ•ÃÂº‰—π≤ÓºÏ≤‚£®µ•ÃÂº‰—π≤Ó>0.3V ¥•∑¢£©           OK
				//(3)»˝∂À±£œ’Àø «∑Ò»€∂œ£®»€∂œ£©         							OK
				//(4)≥‰µÁ∆˜“—¡¨Ω”£®AFE≥‰µÁ∆˜ºÏ≤‚£©                    ¥˝∂®
				//(5)≥‰µÁ∆˜µÁ—π‘⁄’˝≥£∑∂Œß£®34.2°¿0.5V£©								OK		Input_vol_judge();//≈–∂œ≥‰µÁ∆˜µƒ≥‰µÁµÁ—π
				//(6)≥‰µÁµÁ¡˜ºÏ≤‚£®µÁ¡˜–°”⁄10ma ¥•∑¢£©                ¥˝∂®£¨’‚∏ˆ∆‰ µæÕ «bFC≥‰¬˙¡À
				//(7)∑≈µÁµÁ¡˜ºÏ≤‚£®”–∑≈µÁµÁ¡˜ ¥•∑¢£©!!!!!!!!!!!!!!!!  ¥˝∂®£¨“ÚŒ™“—æ≠ «∑«∑≈µÁ◊¥Ã¨
				//(8)∏ﬂŒ¬ºÏ≤‚£®≥¨Œ¬ ¥•∑¢£©                            bOTC
				//(9)µÕŒ¬ºÏ≤‚£®≥¨Œ¬ ¥•∑¢£©									  				bUTC
			  //																										ªπ £:bOCC|| (bFC&&bCHGEnd)
        if(bOTC || bUTC || bHV || bOCC || (bFC&&bCHGEnd))	//∑¢…˙π˝±®¥Ì ≥‰µÁ÷–±®¥Ì							
        {
#if debug
		printf("πÿ±’≥‰µÁmos1-----------\n");    
#endif
					bCHGMOS = 0;  //πÿ±’≥‰µÁmos
        }
    }
		//∑≈µÁπ˝¡˜±£ª§£¨”≤º˛∂Ã¬∑±£ª§£¨ºÏ≤‚±Í÷æŒª «1ªπ”–“—æ≠¡¨Ω”±Í÷æŒª «0
		//																											(bChkChgerFlg&&!bChgerConectFlg))
		if(bOCD || bOCD2 || bAFE_SC  || (bChkChgerFlg&&!bChgerConectFlg))//ºÏ≤‚≥‰µÁ «∑Ò”–≥‰µÁ£¨“≤–Ë“™πÿ±’Cmos
		{
#if debug
		printf("πÿ±’≥‰µÁmos2-----------\n");    
#endif
					bCHGMOS = 0;//πÿ±’≥‰µÁmos
		}
		
#if (tempdebug|chargedebug|discurdebug)
		//◊¢“‚’‚±ﬂµÕŒª◊÷Ω⁄∑≈«∞√Ê£¨∏ﬂŒª◊÷Ω⁄¥Ê¥¢‘⁄∫Û√
		printf("\n µÕ8Œª£∫0,bCTO=%x,bAFE_SC=%x,bAFE_OV=%xÊ,bUTD=%x,bUTC=%x,bOTD=%x,bOTC=%x ∏ﬂ8Œª 0,0,0,bOCD2=%x,bOCD=%x,bOCC=%x,bUV=%x,bHV=%x,\n",((uiBatStatus&0x4000)>>14),((uiBatStatus&0x2000)>>13),((uiBatStatus&0x1000)>>12),((uiBatStatus&0x0800)>>11),\
		((uiBatStatus&0x0400)>>10),((uiBatStatus&0x0200)>>9),((uiBatStatus&0x0100)>>8),((uiBatStatus&0x0010)>>4),((uiBatStatus&0x0008)>>3),((uiBatStatus&0x0004)>>2),((uiBatStatus&0x0002)>>1),(uiBatStatus&0x0001));   
#endif 	
#if debug
		printf("\n bFD = %x,bFC= %x ,LoadConnet_FLG =%bd,bChgerConectFlg =%bd£¨bChkChgerFlg = %bd\n",((uiPackStatus&0x0200)>>9),((uiPackStatus&0x0100)>>8),LoadConnet_FLG,(bChgerConectFlg_test|bChgerConectFlg),(bChgerConectFlg_test|bChkChgerFlg));    
#endif 
#if (tempdebug|chargedebug|discurdebug)
		printf("\n ChkMosStatus(void)uiPackStatus=%x,bCHGMOS=%x,bDSGMOS=%x \n",uiPackStatus,(uiPackStatus&0x0001),(uiPackStatus&0x0002)>>1);    
#endif  	
}


/*******************************************************************************
Function: ControlMos(void)
Description:  
Input:	 	
Output: 
Others:
*******************************************************************************/
void ControlMos(void)
{
    if(bCHGMOS)
    {
        REG.AFESCONF2 |= 0x01;   //≥‰µÁmosøÿ÷∆Œª ø™∆Ù
    }
    else
    {
        REG.AFESCONF2 &= ~0x01;    
    }

    if(bDSGMOS)
    {
        REG.AFESCONF2 |= 0x02;    //∑≈µÁmosµƒø™∆Ù
    }
    else
    {
        REG.AFESCONF2 &= ~0x02;    
    }
        
		//»Áπ˚≤Œ ˝÷µ∫Õ÷Æ«∞“ª—˘æÕ≤ª‘⁄–¥»Î
	if(REG.AFESCONF2 != AFESCONF2Bk)			//If the two variables of the same, is not written to AFE
	{
		AFESCONF2Bk = REG.AFESCONF2;
    TWIWriteAFE(AFE_SCONF2, &REG.AFESCONF2);	 					
	}


}


/*******************************************************************************
Function: RecoveryOC(void)
Description:  
Input:	 	
Output: 
Others:
*******************************************************************************/
void RecoveryOC(void)
{
	if(bOCRC_EN)//π˝¡˜◊‘ª÷∏¥ πƒ‹
	{
		if(bOCD || bAFE_SC|| bOCD2)//∑≈µÁπ˝¡˜±£ª§±Í÷æŒª,∂Ã¬∑±Í÷æŒª
		{
			if(++uiOCDRcnt > OCDR_DELAY_CNT)//>400*25 =10s
			{
               //’‚±ﬂø…ƒ‹“™º”≈–∂œ
								bChkLoadFlg = 0;
                ucLoadRCnt = 0;    
								uiOCDRcnt = 0;
								bOCD = 0;
								//by tomi
								ucOCD2cnt	= 0;
								bOCD2 = 0;
                if(bAFE_SC)
                {
    			        	bAFE_SC = 0;
                    REG.AFESCONF1 |= 0x80;//«Â≥˝±Í÷æºƒ¥Ê∆˜∏˜±£ª§±Í÷æŒª
                    TWIWriteAFE(AFE_SCONF1, &REG.AFESCONF1);
                    REG.AFESCONF1 &= ~0x80;
                    TWIWriteAFE(AFE_SCONF1, &REG.AFESCONF1);
                }
			}
		}
		//by tomi 
		if(bOCC | bAFE_OV)
		{			
			if(++uiOCCRcnt > OCCR_DELAY_CNT)
			{
				uiOCCRcnt = 0;
				bOCC = 0;
				//by tomi 
				bAFE_OV = 0;
				
	      bChkChgerRFlg = 0;
				ucChgerRCnt = 0;
			}
		}
	}
}


/*******************************************************************************
Function: CheckLoad(void)
Description:  
Input:	 	
Output: 
Others:
*******************************************************************************/
void CheckLoad(void)
{
	 U8 bLoadConectFlg_test = 0x00;
    if(!bChkLoadFlg)//ºÏ≤‚∏∫‘ÿ±Í÷æŒª√ª”–ø™∆Ù
    {
        if(bUV) //«∑—π¡À
        {
            bLoadConectFlg = 1;
            bUVBkFlg = 1;
        }
        else if(bUVBkFlg && !bUV) //…œ¥Œ«∑—π¡À£¨’‚¥Œ≤ª«∑—π¡À-°∑∂œø™mos∫Û≤ª«∑—π¡À£¨æÕø™ º∏∫‘ÿºÏ≤‚
        {
						bUVBkFlg = 0;
            bChkLoadFlg = 1;
						ucLoadRCnt = 0;
						REG.AFESCONF1 |= 0x02; //∏∫‘ÿºÏ≤‚
						TWIWriteAFE(AFE_SCONF1, &REG.AFESCONF1);	 				//enable Load Detect	
        }

        if(bOCD || bAFE_SC ||bOCD2)//∑≈µÁπ˝¡˜±£ª§±Í÷æŒª£¨∂Ã¬∑±Í÷æŒª
        {
            bChkLoadFlg = 1;
            bLoadConectFlg = 1; //»Áπ˚ºÏ≤‚’‚º∏∏ˆ¥ÌŒÛµΩ¡Àªπ”–∏∫‘ÿ¡¨Ω”£¨æÕºÃ–¯∂œø™Dmos
						ucLoadRCnt = 0;
						REG.AFESCONF1 |= 0x02;//ø™∆Ù∏∫‘ÿºÏ≤‚
						TWIWriteAFE(AFE_SCONF1, &REG.AFESCONF1);	// πƒ‹∏∫‘ÿºÏ≤‚
        }
    }
		//÷ª”–‘⁄πÿ±’£¨bChkLoadFlg «1¡À£¨«“Dmosπÿ±’¡À£¨≤≈ƒ‹ºÏ≤‚”–√ª”–∏∫‘ÿ
    else 
    {
    	  TWIReadAFE(AFE_BSTATUS, &REG.AFEBSTATUS);
        if((REG.AFEBSTATUS&0x02) == 0)//∏∫‘ÿ¡¨Ω”◊¥Ã¨Œª 1£∫∏∫‘ÿ¡¨Ω” 0Œ¥¡¨Ω”∏∫‘ÿ
        {
            if(++ucLoadRCnt >= (E2ucDelayLoadR*5-1))             //4*125mS
            {
                bChkLoadFlg = 0;
                bLoadConectFlg = 0; 
								bChkChgerFlg = 0;
								bOCD = 0;//∑≈µÁπ˝¡˜«Â¡„
						  	bOCD2 = 0;
                ucLoadRCnt = 0;    
								REG.AFESCONF1 &= ~0x02; //πÿ±’∏∫‘ÿºÏ≤‚π¶ƒ‹
								TWIWriteAFE(AFE_SCONF1, &REG.AFESCONF1);	 				// close Load Detect
							if(bAFE_SC)
							{
										bAFE_SC = 0;//«Âø’ºÏ≤‚±Í÷æŒª
										REG.AFESCONF1 |= 0x80;
										TWIWriteAFE(AFE_SCONF1, &REG.AFESCONF1);
										REG.AFESCONF1 &= ~0x80;
										TWIWriteAFE(AFE_SCONF1, &REG.AFESCONF1);
							}
            }
        }
    }
		LoadConnet_FLG = (bLoadConectFlg_test|bLoadConectFlg);
#if debug
		printf("\n -----bLoadConectFlg =%bd----- \n",(bLoadConectFlg_test|bLoadConectFlg));    
#endif

}


/*******************************************************************************
Function: CheckCharger(void)
Description:  
Input:	 	
Output: 
Others:
*******************************************************************************/
void CheckCharger(void)
{
	U8 bChgerConectFlg_test = 0x00;
    if(bChkChgerFlg)
	{
    	  TWIReadAFE(AFE_BSTATUS, &REG.AFEBSTATUS);
        if((REG.AFEBSTATUS&0x01) != 0)//≥‰µÁ∆˜¡¨Ω”◊¥Ã¨ «1£¨“—¡¨Ω”
        {
					if(++ucChgerCnt >= E2ucDelayLoadR*5)
					{
						bChkChgerFlg = 0;
						bChgerConectFlg = 1;
						ucChgerCnt = 0;
						REG.AFESCONF1 &= ~0x01;//≥‰µÁ∆˜ºÏ≤‚Œª÷√0
						TWIWriteAFE(AFE_SCONF1, &REG.AFESCONF1);	 				// close Charge detect		
		
					}
				}
	}

    if(bChkChgerRFlg)//∑¢…˙π˝≥‰µÁπ˝¡˜£®¥Û”⁄◊‘º∫…Ë÷√µƒ≤Œ ˝£©
    {
    	  TWIReadAFE(AFE_BSTATUS, &REG.AFEBSTATUS);
        if((REG.AFEBSTATUS&0x01) == 0)//≥‰µÁ∆˜Œ¥¡¨Ω”
        {
            if(++ucChgerRCnt >= E2ucDelayLoadR*5)             //4*125mS
            {
              bChkChgerRFlg = 0;
							bOCC = 0;					
              ucChgerRCnt = 0;    
        	    REG.AFESCONF1 &= ~0x01;
            	TWIWriteAFE(AFE_SCONF1, &REG.AFESCONF1);	 				// close Charge detect
							
							//by tomi
							if(bAFE_SC)
							{
									bAFE_OV = 0;//«Âø’ºÏ≤‚±Í÷æŒª
									REG.AFESCONF1 |= 0x80;
									TWIWriteAFE(AFE_SCONF1, &REG.AFESCONF1);
									REG.AFESCONF1 &= ~0x80;
									TWIWriteAFE(AFE_SCONF1, &REG.AFESCONF1);
							}
            }
        }
	}
#if debug
		printf("\n -----≥‰µÁ∆˜¡¨Ω”bChgerConectFlg =%bd£¨bChkChgerFlg = %bd----- \n",(bChgerConectFlg_test|bChgerConectFlg),(bChgerConectFlg_test|bChkChgerFlg));    
#endif
}


/*******************************************************************************
Function: VolProcess()
Description:  
Input:	 	
Output: 
Others:
*******************************************************************************/	
void VolProcess(void)
{
	if(!bBalancingFlg)
	{
		//≈–∂œ «∑Ò≥‰¬˙
	    if(!bFC)//≥‰µÁΩÿ÷π±Í÷æŒª
	    {
				//0x010,0x068,≥‰µÁµÁ—π¥Û”⁄4.2v «“µÁ¡˜“™–°”⁄ 100mA À„≥‰¬˙◊¥Ã¨
	     	if((uiCellVmax>E2uiChgEndVol) && (Info.slCurr<=E2siChgEndCur))   //charge end voltage  ¥Û”⁄4.2V–°”⁄100ma 1s*5 
	    	{
					//E2ucDelayChgEnd  0x005,								// U8  xdata DelayChgEnd   		_at_ 	CHG_PARA_MAP_ADDR+10;	5
	    		if(++ucChgEndcnt >= E2ucDelayChgEnd)
	    		{
	    			bFC = 1;
#if debug
		printf("\n -----bFC ≥‰µÁΩÿ÷π-----uiCellVmax = %d \n",uiCellVmax);    
#endif
	    			ucChgEndcnt = 0;
	          ucChgEndRcnt = 0;
	    		}
	    	}
	        else
	        {
						if(ucChgEndcnt > 0)
						{
							ucChgEndcnt--;
						}
	        }
	    }
	    else
	    {
	    	if(uiCellVmin < E2uiChgEndVol) //charge end recover voltage
	    	{
	    		if(++ucChgEndRcnt >= E2ucDelayChgEnd)
	    		{
	    			bFC = 0;
	          ucChgEndcnt = 0;
	    			ucChgEndRcnt = 0;
	    		}
	    	}
	        else
	        {
						if(ucChgEndRcnt > 0)
						{
							ucChgEndRcnt--;
						}
	        }
	    }
	//∑≈µÁΩÿ÷π
	    if(!bFD)
	    {
				//0x00B,0x054,	2.9V
	    	if(uiCellVmin<E2uiDsgEndVol)	  //discharge end voltage  ∑≈µÁΩÿ÷π1s*5√Î–°”⁄2.9V
	    	{
	    		if(++ucDsgEndcnt >= E2ucDelayDsgEnd)
	    		{
	    			bFD = 1;
#if debug
		printf("\n -----bFD ∑≈µÁΩÿ÷π----- \n");    
#endif
	    			ucDsgEndcnt = 0;
	          ucDsgEndRcnt = 0;
	    		}
	    	}
	        else
	        {
	    		if(ucDsgEndcnt > 0)
	    		{
	    			ucDsgEndcnt--;
	    		}
	        }
	    }
	    else
	    {
	    	if(uiCellVmin > E2uiDsgEndVol)	   //discharge end recover voltage
	    	{										  
	    		if(++ucDsgEndRcnt >= E2ucDelayDsgEnd)
	    		{
	    			bFD = 0;
	    			ucDsgEndcnt = 0;
	    			ucDsgEndRcnt = 0;
	    		}
	    	}
	        else
	        {
						if(ucDsgEndRcnt > 0)
						{
							ucDsgEndRcnt--;
						}
	        }
	    }
	}
#if debug
		printf("\n -----VolProcess(void)-----bFD = %x,bFC= %x\n",((uiPackStatus&0x0200)>>9),((uiPackStatus&0x0100)>>8));    
#endif	
}


/*******************************************************************************
Function: CurrProtect(void)
Description:  
Input:	 	
Output: 
Others:
*******************************************************************************/
void CurrProtect(void)
{
	if(!bOCC)//√ª”–∑¢…˙ ≥‰µÁπ˝¡˜±Í÷æŒª
    {
			//0x000,0x000,0x00B,0x0B8,		 3000mA ≥‰µÁµÁ¡˜
			if(slCadcCurrent > E2slOCCvol)			   //CADC  cycle is 64ms ¥Û”⁄◊‘º∫…Ë÷√µƒπ˝¡˜÷µ
			{
							if(++ucOCCcnt > OCC_DELAY_CNT)
							{
								bOCC = 1;
								ucOCCcnt = 0;

								bChkChgerRFlg = 1;//÷ÿ–¬ºÏ≤‚ «∑Ò≥‰µÁ
								ucChgerRCnt = 0;
								REG.AFESCONF1 |= 0x01;
								TWIWriteAFE(AFE_SCONF1, &REG.AFESCONF1);	 				// close VADC
							}
			}
			else
			{
								if(ucOCCcnt > 0)
								{
										ucOCCcnt--;	
								}
			}
    }
//∑≈µÁπ˝¡˜±£ª§Œª
	if(!bOCD)
    {
				//0xFF,0xFF,0x0B1,0x0E0,  
			if(slCadcCurrent < E2slOCDvol)			   //CADC  cycle is 64ms
			{
							if(++ucOCDcnt > OCD_DELAY_CNT)
							{
									ucOCDcnt = 0;
									bOCD = 1;
							}
			}
			else
			{
					if(ucOCDcnt > 0)
					{
						ucOCDcnt--;	
					}
			}
		}			
//by tomi ∂˛º∂µÁ¡˜±£ª§
//∑≈µÁπ˝¡˜±£ª§Œª
	if(!bOCD2)
    {			
			if(slCadcCurrent < E2slOCD2vol)			   //CADC  40A —” ±100ms
			{
					if(++ucOCD2cnt > OCD2_DELAY_CNT)
					{
							ucOCD2cnt = 0;
							bOCD2 = 1;
					}
			}
			else
			{
					if(ucOCD2cnt > 0)
					{
						ucOCD2cnt--;	
					}
			}
		}		

		
}


/*******************************************************************************
Function: CurrProcess(void)
Description:  
Input:	 	
Output: 
Others:
*******************************************************************************/
#define AverTime  4
void CurrProcess(void)
{
	U8 i;
	S32 Tempdata=0;

	TWIReadAFE(AFE_CURH, (U8 xdata *)&AFE.siCurr);	//Õ®π˝TWI∂¡»°CADC≤…ºØµƒµÁ¡˜÷µ
	
#if 0
	if((AFE.siCurr&0x1000) != 0)					//∏˘æ›bit12≈–∂œ «∑ÒŒ™∏∫ ˝(∑≈µÁµÁ¡˜Œ™∏∫÷µ)£¨»ÁŒ™∏∫÷µ∏ﬂŒª≤π0
	{
		AFE.siCurr|=0xE000; //1110 0000 0000 0000 µ⁄12Œª£∫1±Ì æ∑≈µÁ£¨0±Ì æ≥‰µÁ
	}
	slCadcCurrent = (S32)CALICUR*(AFE.siCurr-E2siCadcOffset)/E2siCadcGain;

	slCadcCurBuf[ucCadcCnt] = slCadcCurrent;		//∂‘¡¨–¯≤…ºØµƒ16¥ŒµÁ¡˜»°∆Ωæ˘÷µ£¨◊˜Œ™µ±«∞µÁ¡˜÷µ
	if(++ucCadcCnt >= 16)
	{
		ucCadcCnt = 0;
	}
	for(i=0; i<16; i++)
	{
		Tempdata += slCadcCurBuf[i];
	}
	slCadcCurAverage = Tempdata/16;	
	
#else
	
	//slCadcCurrent = AFE.siCurr&(~0xE000);
	if((AFE.siCurr&0x1000) != 0)					//∏˘æ›bit12≈–∂œ «∑ÒŒ™∏∫ ˝(∑≈µÁµÁ¡˜Œ™∏∫÷µ)£¨»ÁŒ™∏∫÷µ∏ﬂŒª≤π1
	{
		AFE.siCurr|=0xE000; //1110 0000 0000 0000 µ⁄12Œª£∫1±Ì æ∑≈µÁ£¨0±Ì æ≥‰µÁ
	}
#if (chargedebug|discurdebug)
		printf("\n µ•¥ŒµÁ¡˜÷µAFE.siCurr = %d \n",AFE.siCurr);    
#endif		
	//slCadcCurrent = (S32)AFE.siCurr;
	slCadcCurrent = (S32)CALICUR*(AFE.siCurr-E2siCadcOffset)/E2siCadcGain;   //       (AFE.siCurr-3)/ (-82)
#if (chargedebug|discurdebug)
		printf("\n µÁ¡˜----------------slCadcCurrent ------------------= %ld \n",slCadcCurrent);    
#endif	
	slCadcCurBuf[ucCadcCnt] = slCadcCurrent;
	if(AverTime <= 16)//∑¿ƒ⁄¥Ê≥¨≥ˆ
	{	
		if(++ucCadcCnt >= AverTime)
		{
			ucCadcCnt = 0;
		}
		if(ucCadcCnt == 0)//µΩ¥Ô¡À16¥Œ
		{
			for(i=0; i<AverTime; i++)
			{
				Tempdata += slCadcCurBuf[i];
			}
			slCadcCurAverage = Tempdata/AverTime;
		}
	}	
#endif  
#if (chargedebug|discurdebug)
		printf("\n ∆Ωæ˘µÁ¡˜ CurrProcess(void): slCadcCurAverage = %ld \n",slCadcCurAverage);    
#endif	

	bDSGING = 0;
	bCHGING = 0;
	//< -100mA  
	if(slCadcCurAverage < (-E2siDfilterCur))//∑≈µÁ◊¥Ã¨œ¬∆Ωæ˘µÁ¡˜¥Û”⁄E2siDfilterCur
	{
#if debug
		printf("\n –°”⁄ -100mA \n");    
#endif	
		bDSGING = 1; //’˝‘⁄∑≈µÁ 
		UART_IRQ_DISABLE;
		Info.slCurr = slCadcCurAverage;
		UART_IRQ_ENABLE;
	}
	//rs2 -> rs1≥‰µÁ◊¥Ã¨£¨∂®“ÂµÁ¡˜Œ™’˝
	else if(slCadcCurAverage > E2siDfilterCur) //100
	{
#if debug
		printf("\n ¥Û”⁄ 100mA \n");    
#endif	
		bCHGING = 1;	 //’˝‘⁄≥‰µÁ	
		UART_IRQ_DISABLE;
		Info.slCurr = slCadcCurAverage;
		UART_IRQ_ENABLE;
	}
	else
	{
		UART_IRQ_DISABLE;
		Info.slCurr = 0;
		UART_IRQ_ENABLE;
	}
//»Ù’˝‘⁄≥‰µÁ£¨“™◊ˆµƒ∂Ø◊˜£¨“ª∞„ «LED÷∏ æ
    if(bCHGING)						//debounce: flick led charging
    {
#if chargedebug
				printf("\n is charging \n");
#endif
//        if(!bLEDChgFlg)
//        {
//            if(++ucLedChgCnt > 8)
//            {
//                bLEDChgFlg = 1;
//                ucLedChgCnt = 0;
//            }
//        }
//        else
//        {
//            if(ucLedChgCnt > 0)
//            {
//                ucLedChgCnt--;
//            }
//        }
    }
    else //≤ª‘⁄≥‰µÁ
    {
#if chargedebug
				printf("\n is  not charging \n");
#endif
//        if(!bLEDChgFlg)
//        {
//            if(ucLedChgCnt > 0)
//            {
//                ucLedChgCnt--;
//            }
//        }
//        else
//        {
//            if(++ucLedChgCnt > 8)
//            {
//                bLEDChgFlg = 0;
//                ucLedChgCnt = 0;
//            }
//        }    
    }
#if 0
				printf("\n CurrProcess uiPackStatus =%hx ---µÕ8Œª£∫bCAL =%x,0,0,0,0,bVDQ=%x,bFD=%x,bFC=%x ∏ﬂ8Œª:0,bFastDischarge=%x,bMidDischarge=%x,bSlowDischarge=%x,bDSGING=%x,bCHGING=%x,bDSGMOS=%x,bCHGMOS=%x\n",uiPackStatus,((uiPackStatus&0x8000)>>15),((uiPackStatus&0x0400)>>10),((uiPackStatus&0x0200)>>9),((uiPackStatus&0x0100)>>8),\
		((uiPackStatus&0x0040)>>6),((uiPackStatus&0x0020)>>5),((uiPackStatus&0x0010)>>4),((uiPackStatus&0x0008)>>3),((uiPackStatus&0x0004)>>2),((uiPackStatus&0x0002)>>1),(uiPackStatus&0x0001));      
#endif
	CurrProtect();
}


/*******************************************************************************
Function: AFERamCheck(void)
Description: 
Input:	 	
Output: 
Others:
*******************************************************************************/
void AFERamCheck(void)
{
	U8 xdata RdBuf[2];
	U8 i;

	for(i=3; i<=11; i=i+2)		//¥”ø…–¥ºƒ¥Ê∆˜03Hø™ º±»Ωœ   // 03H  05H 07H 09H 0BH
	{
		TWIReadAFE(i, RdBuf); 

        if((RdBuf[0]!=*(&REG.AFEFLAG1+i)) || (RdBuf[1]!=*(&REG.AFEFLAG1+i+1)))
        {
					if(i != 7) //07H « ˝æ›Œª
					{
									InitAFE();		
									break;
					}
        }
	}
}


/*******************************************************************************
Function: AlarmProcess(void)
Description:  
Input:	NULL 	
Output: NULL
Others:
*******************************************************************************/
void AlarmProcess(void)
{
	TWIReadAFE(AFE_FLAG1, &REG.AFEFLAG1);	//∂¡»°AFEºƒ¥Ê∆˜FLAG1 & FLAG2÷–µƒAlarm±Í÷æ

	if((REG.AFEFLAG2&0x02) != 0)	//CADC µÁ¡˜◊™ªªÕÍ≥… 
	{
		bCADCFlg = 1;
#if debug
		printf("\n Cur trans OK! \n");    
#endif	
	}

	if((REG.AFEFLAG2&0x01) != 0)	//VADC µÁ—π◊™ªªÕÍ≥…
	{
		bVADCFlg = 1;
#if debug
		printf("\n VOL trans OK! \n");    
#endif	
	}

	if((REG.AFEFLAG1&0x08) != 0)	//AFE ∂Ã¬∑±£ª§
	{
		bAFE_SC = 1;
		Info.uiPackStatus = uiPackStatus;
	}

	if((REG.AFEFLAG1&0x04) != 0)	//AFE π˝—π±£ª§
	{
		bAFE_OV = 1;
		//by tomi
		bChkChgerRFlg = 1; //◊‘ª÷∏¥
		Info.uiPackStatus = uiPackStatus;
	}

	if((REG.AFEFLAG2&0x04) != 0)	//≈–∂œFLAG2µƒbit2 «∑ÒŒ™1£¨»ÁŒ™1‘Ú±Ì æAFE∑¢…˙π˝LVR£¨–Ë“™÷ÿ–¬≥ı ºªØAFEºƒ¥Ê∆˜
	{
		InitAFE();
#if debug
		printf("AFEµƒrst∑¢…˙π˝LVR \n");    
#endif	
	}

#if debug
		printf("\n uiPackStatus =%hx ---µÕ8Œª£∫bCAL =%x,0,0,0,0,bVDQ=%x,bFD=%x,bFC=%x ∏ﬂ8Œª:0,bFastDischarge=%x,bMidDischarge=%x,bSlowDischarge=%x,bDSGING=%x,bCHGING=%x,bDSGMOS=%x,bCHGMOS=%x\n",uiPackStatus,((uiPackStatus&0x8000)>>15),((uiPackStatus&0x0400)>>10),((uiPackStatus&0x0200)>>9),((uiPackStatus&0x0100)>>8),\
		((uiPackStatus&0x0040)>>6),((uiPackStatus&0x0020)>>5),((uiPackStatus&0x0010)>>4),((uiPackStatus&0x0008)>>3),((uiPackStatus&0x0004)>>2),((uiPackStatus&0x0002)>>1),(uiPackStatus&0x0001));   

#endif 
	
}	
	

/*******************************************************************************
Function:WaitADCConvert(void) 
Description:  
Input:	NULL 	
Output: NULL
Others:
*******************************************************************************/
bit WaitADCConvert(void)
{
    U8 i;
    BOOL result=0;

    while(i++ < 60)
    {
        Delay1ms(5);
    	TWIReadAFE(AFE_FLAG1, &REG.AFEFLAG1);		//read AFE FLAG1 search for which state  trigged ALARM
    	if((REG.AFEFLAG2&0x01) != 0)				//VADC interrupt
    	{
			while(i++ < 60)
    		{
		        Delay1ms(5);
		    	TWIReadAFE(AFE_FLAG1, &REG.AFEFLAG1);		//read AFE FLAG1 search for which state  trigged ALARM
		    	if((REG.AFEFLAG2&0x02) != 0)				//CADC interrupt
		    	{
		    		result = 1;
		            break;
		    	}
    		}
            break;
    	}
    }

    return result;
}


/*******************************************************************************
Function: PorOnProtect(void)
Description:  
Input:	NULL 	
Output: NULL
Others:
*******************************************************************************/
void PorOnProtect(void)
{
	//µ•–æπ˝≥‰	E2uiOVvol > 0x010,0x09A,4250 > 4.25V -->4.175
	if(uiCellVmax > E2uiOVvol)//E2uiOVvolπ˝≥‰µÁ±£ª§„–÷µ    
	{		
		bHV = 1;
#if debug
		TI = 0;
		TI = 1;	
		printf("\n --π˝≥‰bHV-- \n");   
#endif  
	}
 //E2uiUVvol = 0x00A,0x08C,	2.7v
	if(uiCellVmin < E2uiUVvol)//«∑—π±£ª§„–÷µ
	{		
		bUV = 1;
	  bChkChgerFlg = 1;//ºÏ≤È≥‰µÁ∆˜±Í÷æ÷√1
	  bChgerConectFlg = 0;//“—¡¨Ω”±Í÷æ«Âø’
		ucChgerCnt = 0;
		// πƒ‹≥‰µÁ∆˜ºÏ≤‚
		REG.AFESCONF1 |= 0x01;
		TWIWriteAFE(AFE_SCONF1, &REG.AFESCONF1);	 				//enable charger detect 
#if debug
		printf("\n --«∑—πbUV--\n");   
#endif  
	}

	if(uiTempeMax > E2uiTempOTC)//	0x00C,0x09F,						// U16 xdata TempOTC      		_at_ 	CHG_TEMP_PARA_MAP_ADDR;		3231-2731=500
	{
		bOTC = 1;
#if debug
		printf("\n --≥‰π˝Œ¬bOTC--\n");   
#endif  
	}

	if(uiTempeMin < E2uiTempUTC) //0…„ œ∂»
	{
		bUTC = 1;
#if debug
		printf("\n --≥‰µÕŒ¬bUTC-\n");   
#endif  
	}
	if(uiTempeMax > E2uiTempOTD)//70 …„ œ∂»    3461
	{
		bOTD = 1;
#if debug
		printf("\n --∑≈∏ﬂŒ¬bOTD-\n");   
#endif 
	}

	if(uiTempeMin < E2uiTempUTD)//-10…„ œ∂» 
	{
		bUTD = 1;
#if debug	
		printf("\n --∑≈µÕŒ¬bUTD--\n");   
#endif 
	}
//
//sbit bHV			=	uiBatStatus^8;//π˝≥Â±£ª§±Í÷æŒª
//sbit bUV			=	uiBatStatus^9;//π˝∑≈±£ª§±Í÷æŒª
//sbit bOCC 			= 	uiBatStatus^10;//≥‰µÁπ˝¡˜±£ª§±Í÷æŒª 1∑¢…˙π˝±£ª§
//sbit bOCD 			= 	uiBatStatus^11;//∑≈µÁπ˝¡˜±£ª§±Í÷æŒª
//sbit bOCD2 			= 	uiBatStatus^12;//∑≈µÁπ˝¡˜2±£ª§±Í÷æŒª
	
//sbit bOTC 			=	uiBatStatus^0;//≥‰µÁ∏ﬂŒ¬±£ª§
//sbit bOTD 			= 	uiBatStatus^1;//∑≈µÁ∏ﬂŒ¬±£ª§
//sbit bUTC			=	uiBatStatus^2;//≥‰µÁµÕŒ¬±£ª§
//sbit bUTD			=	uiBatStatus^3;//∑≈µÁµÕŒ¬±£ª§
//sbit bAFE_OV		=	uiBatStatus^4;//”≤º˛π˝≥Â±£ª§
//sbit bAFE_SC		=	uiBatStatus^5;//”≤º˛∂Ã¬∑±£ª§
//sbit bCTO			=	uiBatStatus^6; //‘§¡ÙŒª£¨∂œœﬂ±£ª§

#if debug
		TI = 0;
		TI = 1;	
		printf("\n PorOnProtect() uiBatStatus = %x\n",uiBatStatus);   
#endif  

#if debug
		//◊¢“‚’‚±ﬂµÕŒª◊÷Ω⁄∑≈«∞√Ê£¨∏ﬂŒª◊÷Ω⁄¥Ê¥¢‘⁄∫Û√Ê
		printf("\n µÕ8Œª£∫0,bCTO=%x,bAFE_SC=%x,bAFE_OV=%x,bUTD=%x,bUTC=%x,bOTD=%x,bOTC=%x ∏ﬂ8Œª 0,0,0,bOCD2=%x,bOCD=%x,bOCC=%x,bUV=%x,bHV=%x,\n",((uiBatStatus&0x4000)>>14),((uiBatStatus&0x2000)>>13),((uiBatStatus&0x1000)>>12),((uiBatStatus&0x0800)>>11),\
		((uiBatStatus&0x0400)>>10),((uiBatStatus&0x0200)>>9),((uiBatStatus&0x0100)>>8),((uiBatStatus&0x0010)>>4),((uiBatStatus&0x0008)>>3),((uiBatStatus&0x0004)>>2),((uiBatStatus&0x0002)>>1),(uiBatStatus&0x0001));   
#endif  
	
		/*********by tomi********/

		Input_charger_detect_poron();//≈–∂œ≥‰µÁ∆˜”–√ª”–≤Â 

		if(ConectFlg_poron == 1)
		{
#if 1 
			printf("\n ≥‰µÁ∆˜“—¡¨Ω”\n");
#endif
			Input_vol_judge_poron();//≈–∂œ≥‰µÁ∆˜µƒ≥‰µÁµÁ—π	
		}	
		else//»Áπ˚≥‰µÁ∆˜≤ª¡¨Ω”¡À,«Âø’¥ÌŒÛ±Í÷æŒª
		{			
#if 1 
			printf("\n «Âø’OIV UIV\n");
#endif			
			OIV = 0;
			UIV = 0;
		}
		
	 // Chk_Fuse_poron(); //ºÏ≤È”–√ª”–»€∂œ£®…œµÁÀ≤º‰≤ªºÏ≤È»€∂œ£©
	  Chk_Cell_VolDIFF_poron();//—π≤Ó±£ª§

		MCU_CHK_CDmos();
	/***************************/

    ChkMosStatus();				 
    ControlMos();
#if 1
		updata_pack_fault_flag();
#endif
}


/*******************************************************************************
Function: ProtectProcess(void)
Description:  
Input:	 	
Output: 
Others:
*******************************************************************************/
void ProtectProcess(void)
{
	//≤ª «∂œœﬂªÚ’ﬂ «‘⁄∆Ω∫‚◊¥Ã¨œ¬
	if(!(bCellOpenDecFlag || bBalanceFlg))//‘⁄∂œœﬂºÏ≤‚∫Õ∆Ω∫‚µƒ◊¥Ã¨œ¬£¨≤ª◊ˆµÁ—π±£ª§
	{
		//µÁ—π±£ª§≥Ã–Ú£®bHV£©
		VolProtect();			
	}
		//Œ¬∂»±£ª§≥Ã–Ú
		TempeProtect();		
//-------------------------------------------------------------------------------------------------	
#if 0
		/*********by tomi********/
	//‘À––∆¿¥∫Û£¨ £®1£©‘⁄~(AFE_CHG_MOS  = 1«“IO_CHG_MOS= 0) Ãıº˛£®2£©£∫…œ¥Œ√ª”–≥‰µÁ∆˜’‚¥Œ”–≥‰µÁ∆˜¡À £¨ªπ”–“ª÷÷ «≥‰µÁmos√ª”–ø™∆Ù
		if(!((IO_CHG_MOS == 0) && ((uiPackStatus&0x0001) == 1)) )//‘⁄∂ºπÿ±’µƒ◊¥Ã¨œ¬
		{
#if debug
			printf(" \n");
#endif
			Input_charger_detect_poron();//≈–∂œ≥‰µÁ∆˜”–√ª”–≤Â
			if(ConectFlg_poron == 1)
			{
				Input_vol_judge();//≈–∂œ≥‰µÁ∆˜µƒ≥‰µÁµÁ—π
			}	
			else
			{
				OIV = 0;
				UIV = 0;
			}
		}
#endif	
		/*********by tomi********/
//‘À––∆¿¥∫Û£¨ £®1£©‘⁄~(AFE_CHG_MOS  = 1«“IO_CHG_MOS= 0) Ãıº˛£®2£©£∫…œ¥Œ√ª”–≥‰µÁ∆˜’‚¥Œ”–≥‰µÁ∆˜¡À £¨ªπ”–“ª÷÷ «≥‰µÁmos√ª”–ø™∆Ù
		if(bCHGING == 0)//»Áπ˚≤ª‘⁄≥‰µÁ¡À
		{		
			if(++CHGING_cnt >= 4)
			{
				CHGING_cnt = 0;
				IO_CHG_MOS = 1;//πÿ±’≥‰µÁmos
				Input_charger_detect();//≈–∂œ≥‰µÁ∆˜”–√ª”–≤Â
				if(ConectFlg_poron == 1)
				{
					//1.CMOS√ª”–¥Úø™
					if(!((IO_CHG_MOS == 0) && ((uiPackStatus&0x0001) == 1)) )//‘⁄∂ºπÿ±’µƒ◊¥Ã¨œ¬
					{
#if chargedebug
						printf("Input_vol_judge—” ±ºÏ≤‚\n");
#endif	
						if(ConectFlg_poron_prev == 1)//
						{
							Input_vol_judge();//≈–∂œ≥‰µÁ∆˜µƒ≥‰µÁµÁ—π£¨”–—” ±µƒ≈–∂œ
						}
						else//»Áπ˚…œ¥Œ «µ⁄“ª¥Œ≤Â
						{
							Input_vol_judge_poron();//“ÚŒ™÷ª≤…ºØ“ª¥ŒÀ˘“‘≤ª”√µ»¥˝ª÷∏¥
						}
								
					}	
					//2.CMOS¥Úø™¡À
	//				else
	//				{
	//					//æÕ“™≈–∂œ£¨…œ“ª¥Œ «∑Ò√ª≤Â ≥‰µÁ∆˜
	//					if(ConectFlg_poron_prev == 0)
	//					{
	//#if chargedebug
	//						printf("Input_vol_judge_poronµ•¥ŒºÏ≤‚\n");
	//#endif							
	//						Input_vol_judge_poron();//µ•¥ŒºÏ≤‚
	//					}
	//				}
				}
				else
				{	
#if chargedebug
						printf("&&&&&&&&&&&&&&2\n");
#endif				
					OIV = 0;
					UIV = 0;
				}			
			ConectFlg_poron_prev = ConectFlg_poron;
#if chargedebug
			printf("ConectFlg_poron_prev2=%bd\n",ConectFlg_poron_prev);
#endif	
			}			
		}		
		else
		{
			CHGING_cnt = 0;
		}
		
	  Chk_Fuse(); //ºÏ≤È”–√ª”–»€∂œ
  	Chk_Cell_VolDIFF();


		
		MCU_CHK_CDmos();
//-------------------------------------------------------------------------------------------------	
	
	//mos◊¥Ã¨ºÏ≤‚∫Õ¥¶¿Ì
    ChkMosStatus();		
    ControlMos(); 
#if 1
		updata_pack_fault_flag(); //25ms÷¥––“ª¥Œ
#endif
	
		Info.uiBatStatus = uiBatStatus;
		Info.uiPackStatus = uiPackStatus;
//π˝¡˜◊‘ª÷∏¥ πƒ‹
    RecoveryOC();

    CheckLoad();
//≤ª∂œµƒ»•ºÏ≤‚≥‰µÁ∆˜ «∑Ò±ª≤Â»Î
    CheckCharger();

}


/*******************************************************************************
Function: IntoPowerDown(void)
Description:  
Input:	 	
Output: 
Others:	   FOR UART 
*******************************************************************************/
void IntoPowerDown(void)
{
	REG.AFESCONF10 = 0x33;						//Ω¯»ÎPower Downƒ£ Ω
	TWIWriteAFE(AFE_SCONF10, &REG.AFESCONF10);
	REG.AFESCONF1 |= 0x20; 
	TWIWriteAFE(AFE_SCONF1, &REG.AFESCONF1);
}

